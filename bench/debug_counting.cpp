#include "../include/parallel_avl.hpp"
#include <iostream>
#include <thread>
#include <vector>
#include <set>

int main() {
    std::cout << "=== Debug Counting Mismatch ===\n\n";

    constexpr size_t NUM_THREADS = 8;
    constexpr size_t OPS_PER_THREAD = 5000;

    // Count unique keys generated by the attack
    std::set<int> unique_keys;
    for (size_t tid = 0; tid < NUM_THREADS; ++tid) {
        for (size_t i = 0; i < OPS_PER_THREAD; ++i) {
            int key = tid * OPS_PER_THREAD + i;
            key = (key / 8) * 8;
            unique_keys.insert(key);
        }
    }
    
    std::cout << "Total operations: " << NUM_THREADS * OPS_PER_THREAD << "\n";
    std::cout << "Unique keys in attack: " << unique_keys.size() << "\n";
    std::cout << "Duplicate insertions: " << (NUM_THREADS * OPS_PER_THREAD - unique_keys.size()) << "\n\n";

    // Now run the actual test
    ParallelAVL<int, int> tree(8, ParallelAVL<int, int>::RouterStrategy::LOAD_AWARE);
    
    std::vector<std::thread> threads;
    for (size_t tid = 0; tid < NUM_THREADS; ++tid) {
        threads.emplace_back([&tree, tid]() {
            for (size_t i = 0; i < OPS_PER_THREAD; ++i) {
                int key = tid * OPS_PER_THREAD + i;
                key = (key / 8) * 8;
                tree.insert(key, key);
            }
        });
    }
    for (auto& t : threads) t.join();
    
    auto stats = tree.get_stats();
    
    std::cout << "After attack:\n";
    std::cout << "  Total elements in tree: " << stats.total_size << "\n";
    std::cout << "  Total operations counted: " << stats.total_ops << "\n";
    std::cout << "  Router balance: " << (stats.balance_score * 100) << "%\n";
    std::cout << "  Shard sizes: [";
    for (size_t i = 0; i < stats.shard_sizes.size(); ++i) {
        if (i > 0) std::cout << ", ";
        std::cout << stats.shard_sizes[i];
    }
    std::cout << "]\n\n";
    
    std::cout << "Analysis:\n";
    std::cout << "  If router counts ALL record_insertion() calls: " << stats.total_ops << "\n";
    std::cout << "  But tree only has unique elements: " << stats.total_size << "\n";
    std::cout << "  Difference (duplicate inserts not adding to tree): " 
              << (stats.total_ops - stats.total_size) << "\n";
    
    return 0;
}
